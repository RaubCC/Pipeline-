<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity: water Pipe Tetris</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="img/cw_logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
          --cw-blue: #2BB673;
          --cw-white: #fff;
        }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
        }
        #loading-message {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #2E9DF7;
            z-index: 200;
        }
        #game-over-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(46,157,247,0.85);
            color: #fff;
            font-size: 2.2rem;
            font-weight: bold;
            align-items: center;
            justify-content: center;
            z-index: 150;
            flex-direction: column;
        }
        #game-over-overlay.active {
            display: flex;
        }
        #instructions {
            background: #fff;
            border: 2px solid #2E9DF7;
            border-radius: 10px;
            padding: 1rem 2rem;
            margin: 1rem auto 1.5rem auto;
            max-width: 420px;
            color: #222;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(46,157,247,0.10);
        }
        #game-container {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
        }
        #sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 180px;
            max-width: 260px;
            width: 100%;
        }
        #tetris {
            max-width: 90vw;
            height: auto;
            width: 300px;
            min-width: 180px;
        }
        @media (max-width: 900px) {
            #game-container {
                flex-direction: column;
                align-items: center;
            }
            #sidebar {
                max-width: 100vw;
                min-width: 0;
                width: 100%;
                align-items: center;
            }
        }
        @media (max-width: 600px) {
            #tetris {
                width: 90vw;
                min-width: 120px;
                max-width: 98vw;
            }
            #sidebar {
                max-width: 98vw;
                padding: 0 2vw;
            }
            #instructions {
                font-size: 0.95rem;
                padding: 0.7rem 0.5rem;
            }
        }
        @keyframes jerry-bounce {
          0% { transform:translateY(0) scale(1); opacity: 0.8;}
          30% { transform:translateY(-36px) scale(1.08);}
          70% { transform:translateY(0) scale(0.95);}
          100% { transform:translateY(80px) scale(0.7); opacity:0;}
        }
        #water-meter {
          width: 100%;
          max-width: 220px;
          height: 22px;
          background: var(--cw-white);
          border: 2px solid var(--cw-blue);
          border-radius: 12px;
          margin: 0.5rem auto 0.7rem auto;
          box-shadow: 0 2px 8px rgba(43,182,115,0.08);
          overflow: hidden;
          position: relative;
        }
        #water-meter #fill {
          height: 100%;
          width: 0%;
          background: linear-gradient(90deg, var(--cw-blue) 80%, #2E9DF7 100%);
          border-radius: 12px 0 0 12px;
          transition: width 0.5s cubic-bezier(.4,1.4,.6,1);
        }
        /* Drop icon animation for squirt/ripple effect */
        .drop {
          display: inline-block;
          transition: transform 0.2s ease;
        }
        .drop.active {
          transform: scale(1.2) translateY(-5px);
        }
    </style>
</head>
<body>
    <h1 class="visually-hidden">Charity: water Pipe Tetris Game</h1>
    <div id="loading-message">Loading Charity: water Tetris...</div>
    <header>
        <img src="img/cw_logo_horizontal.png" alt="Charity: water logo" class="cw-logo-horizontal">
        <h1>Charity: water Pipe Tetris</h1>
    </header>
    <!-- Difficulty selector added just above the game board -->
    <div id="difficulty-selector" class="difficulty-selector">
      <label for="difficulty">Difficulty: </label>
      <select id="difficulty">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
      </select>
    </div>
    <div id="instructions" tabindex="0">
        <strong>How to Play:</strong><br>
        Use <b>Arrow keys</b> to move and rotate pieces.<br>
        <b>Space</b> to drop, <b>Enter</b> to restart after game over.<br>
        Clear lines to deliver clean water and unlock fun facts!
    </div>
    <main>
        <button id="board-demo-btn" onclick="renderPipeBoardDemo()">Show Pipe Block Demo (DOM)</button>
        <div id="board"></div>
        <div id="game-container">
            <canvas id="tetris" width="300" height="600" aria-label="Tetris game board" tabindex="0"></canvas>
            <!-- Mobile Controls: Only visible on small screens -->
            <div id="mobile-controls" class="mobile-controls">
                <button id="btn-left" aria-label="Move Left">&#8592;</button>
                <button id="btn-rotate" aria-label="Rotate">&#8635;</button>
                <button id="btn-right" aria-label="Move Right">&#8594;</button>
                <button id="btn-drop" aria-label="Drop">&#8595;</button>
            </div>
            <div id="sidebar">
                <div id="next-piece">
                    <h3>Next Piece</h3>
                    <canvas id="next" width="160" height="120" aria-label="Next Tetris piece" tabindex="0"></canvas>
                </div>
                <button id="sidebar-toggle" aria-label="Toggle sidebar">â˜°</button>
                <div id="score-label">Your Score</div>
                <h2 id="water-delivered">Liters Delivered: 0</h2>
                <div id="water-meter"><div id="fill"></div></div>
                <div id="lines-to-next">Next Level in 8 lines</div>
                <div id="level-display" class="level-display">Level: 1</div>
                <button id="pause-btn" aria-label="Pause game">Pause</button>
                <button id="restart" aria-label="Restart game" tabindex="0">Restart</button>
                <div id="fact-section" class="fact-section">
                    <strong>Charity: water Fact</strong>
                    <div id="fact-rotator" class="fact-rotator"></div>
                </div>
            </div>
        </div>
        <div id="fact-popup" class="fact-popup">
            <p id="fact-text"></p>
            <button id="close-fact" aria-label="Close fact popup" tabindex="0">OK</button>
        </div>
        <div id="game-over-overlay">
            <div>Game Over!<br><span id="final-liters"></span></div>
            <button id="overlay-restart" tabindex="0">Restart</button>
        </div>
        <div id="how-to-modal" class="how-to-modal">
            <div class="how-to-modal-inner">
                <h2>How to Play</h2>
                <p>Use <b>Arrow keys</b> to move and rotate pieces.<br> <b>Space</b> to drop, <b>Enter</b> to restart after game over.<br>Clear lines to deliver clean water and unlock fun facts!<br><br>Watch out for mud blocks and level up for more challenge!</p>
                <button id="close-how-to" class="close-how-to">OK</button>
            </div>
        </div>
        <!-- Jerry Can Bounce Animation -->
    <div id="jerrycan-bonus" class="jerrycan-bonus">
      <!-- SVG Jerry Can -->
      <svg id="svg-jerrycan" width="90" height="90" viewBox="0 0 90 90" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="15" y="18" width="50" height="54" rx="10" fill="#FFC907" stroke="#222" stroke-width="4"/>
        <rect x="28" y="10" width="18" height="16" rx="4" fill="#FFC907" stroke="#222" stroke-width="3"/>
        <rect x="53" y="26" width="10" height="38" rx="3" fill="#fff" stroke="#222" stroke-width="2" opacity="0.3"/>
        <rect x="37" y="38" width="8" height="18" rx="2" fill="#fff" opacity="0.35"/>
        <rect x="36" y="70" width="12" height="6" rx="2" fill="#FFD442" opacity="0.5"/>
        <rect x="62" y="28" width="4" height="20" rx="1.5" fill="#fff" opacity="0.2"/>
        <rect x="17" y="32" width="6" height="34" rx="2" fill="#fff" opacity="0.13"/>
      </svg>
    </div>

    <!-- Mud Splatter Animation -->
    <div id="mud-splatter" class="mud-splatter">
      <!-- SVG Mud Splatter -->
      <svg id="svg-mudsplatter" width="112" height="90" viewBox="0 0 112 90" fill="none" xmlns="http://www.w3.org/2000/svg">
        <ellipse cx="56" cy="55" rx="44" ry="28" fill="#8B5C2A"/>
        <ellipse cx="33" cy="40" rx="12" ry="6" fill="#8B5C2A" />
        <ellipse cx="82" cy="44" rx="9" ry="5" fill="#8B5C2A" />
        <ellipse cx="56" cy="70" rx="16" ry="8" fill="#6B3E14" opacity="0.7"/>
        <ellipse cx="18" cy="61" rx="5" ry="2" fill="#8B5C2A" opacity="0.8"/>
        <ellipse cx="100" cy="68" rx="6" ry="3" fill="#8B5C2A" opacity="0.6"/>
        <ellipse cx="22" cy="85" rx="4" ry="8" fill="#8B5C2A" />
        <ellipse cx="108" cy="80" rx="3" ry="6" fill="#8B5C2A" />
        <ellipse cx="77" cy="83" rx="5" ry="10" fill="#8B5C2A" />
        <ellipse cx="56" cy="90" rx="6" ry="5" fill="#8B5C2A" />
      </svg>
    </div>

    <!-- Bucket Fill Animation -->
    <div id="bucket-animation" class="bucket-animation">
      <div class="bucket-animation-inner">
        <!-- SVG Jerry Can reused for bucket visual -->
        <svg width="90" height="90" viewBox="0 0 90 90" fill="none" xmlns="http://www.w3.org/2000/svg" class="bucket-svg">
          <rect x="15" y="18" width="50" height="54" rx="10" fill="#FFC907" stroke="#222" stroke-width="4"/>
          <rect x="28" y="10" width="18" height="16" rx="4" fill="#FFC907" stroke="#222" stroke-width="3"/>
        </svg>
        <div id="bucket-water" class="bucket-water"></div>
      </div>
    </div>
    <!-- Add splash effect container for game effects -->
    <div id="splash-effect"></div>
    </main>
    <footer>
        <p>Made for learning and fun &mdash; <a href="https://www.charitywater.org/" target="_blank" rel="noopener">Charity: water</a></p>
    </footer>
    <script>
        // Hide loading message when page and scripts are ready
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loading-message').style.display = 'none';
        });
    </script>
    <script src="script.js"></script>
</body>
</html>
